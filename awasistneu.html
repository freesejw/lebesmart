<!DOCTYPE html>
<html>
<head>
        <meta charset="utf-8">    
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>

Canvas {
   position: absolute;
   top: 0px;
   left: 0px;
   border: 1px red solid;
   background-color: #FFEFDB;
}
</style>
</head>
<body onload="ladeGame()">
    <canvas id="canvas" width="500" height="600"></canvas>
     
<script>
var canv = document.getElementById("canvas");
var ctx = canv.getContext("2d");
var cW = ctx.canvas.width, cH = ctx.canvas.height;  

var xBreite=60 , yHoehe=70;
var myVar; // für setInterval
var getipptRechteck; // gibt an welcher Button / Rechteck angetippt wurde
var schrittWeite=1,maxDurchlaeufe=4;
var durchLaeufe, treffer;
var bgColor="lightblue";
var blinkReihe=[],positionsReihe=[];
var vergleichIndex; // dient zur abfrage welcher Button / rechteck angeklickt wurdej
var repeator, warten=false ;
var pic=[], anzahlBilder=52;
var xCoord=[], yCoord=[];
var zeilen = 5, spalten=5;
var xAbstand=30,yAbstand = 70;     // Verschiebt die Matrix nach rechts und unten
var xBasis=20, yBasis1=250, wBasis1=60, hBasis=40, dBasis=40, xtestdis=10, ytextdis=25;
var yBasis2= 510, wBasis2=120, yErhoehung=50; 
var warteZeit=3;
var zaehlerClick;
var zaehlerTreffer;
var iterator=0;
var anzahlBlinks=4;


//Rechtecke für die Bilder
var rects = [ {x: xBasis, y: yBasis2, w: wBasis2, h: hBasis,col: bgColor},
             {x: (xBasis + wBasis2+ dBasis), y: yBasis2, w: wBasis2, h: hBasis,col: bgColor},
             {x: (xBasis + 2 * (wBasis2+ dBasis)), y: yBasis2, w: wBasis2, h: hBasis,col: bgColor},
             {x: (xBasis + 2 * (wBasis2+ dBasis)), y: yBasis2 + yErhoehung, w: wBasis2, h: hBasis,col: bgColor}];
 
var texts = [{na: "Go on", x: xBasis + xtestdis -10, y: yBasis2 + ytextdis},
            {na: "Abbruch", x: (xBasis + xtestdis +  wBasis2 + dBasis),y: yBasis2 + ytextdis} ,
            {na: "Langsamer", x: (xBasis + xtestdis + 2 * (wBasis2+ dBasis)),y: yBasis2 + ytextdis },
            {na: "Schneller", x: (xBasis + xtestdis + 2 * (wBasis2+ dBasis)),y: yBasis2 + yErhoehung + ytextdis }];

function ladeGame() 
    {   
        meldung("Übe die Merkspanne","18px Arial","black",40, 25);    
        meldung("Welche Karte ist neu ?","18px Arial","black",40, 50);    
        erzeugeDieRechtecke(0,3);
        rechteckeText();  // und hier mit Text versehen falls keine bilder genommen werden 
        aufbauMatrix(zeilen,spalten,xBreite,yHoehe);
        warteZeit=4;
        treffer=0;
        durchLaeufe=0;
        einlesenBilder();
        iterator=3;
        blinkReihe=auswahlBlinkZellen(zeilen,spalten);
        positionsReihe=auswahlBlinkZellen(zeilen,spalten);
        zeichneVorgabeBilder(iterator);
       
     
    }
   
    function aufbauMatrix(zeilen,spalten,breite,hoehe)
{
   // legt eine Matrix an . In derren Elemente werden nachfolgend die ausgewählten Bilder gezeichnet
    for (let i = 0; i<zeilen; i++)
    {
        var y=yAbstand+hoehe*i;
        for(let j=0;j < spalten;j++)
        {            
            var x=xAbstand + breite*j;  
            ctx.lineWidth="1";
            ctx.strokeStyle="red";       
            ctx.rect(x,y,xBreite,yHoehe);
            ctx.stroke();
            //linke, obere Koordinaten der Rechtecke
            xCoord.push(x);
            yCoord.push(y);
       
        }
    }   
}  

function auswahlBlinkZellen(zeilen,spalten)
{
var zw=[];
for (var i =0; i<zeilen*spalten;i++)
    {
        zw.push(i);    
        
    }
return shuffle(zw);
}

canv.addEventListener('click', function(event)
 {   
    
            xclick = event.clientX; 
            yclick = event.clientY;  
        
    if (xclick>xCoord[0] && (xclick < xCoord[spalten-1]+xBreite)
                        &&  yclick > yCoord[0] &&(yclick<yCoord[zeilen*spalten-1]+yHoehe))
       {
            zaehlerClick++;        
            var zwert = geglicktesFeld(xclick,yclick) // liefert den Index des getippten feldes 
            var zw =positionsReihe[iterator-1];
           
            
                    if (zw == zwert)
                        {
                            treffer++
                            meldung("Treffer  " + treffer ,"18px Arial","black",30,460);  
                            zaehlerTreffer++;
                            xxclick=(Math.floor(xclick/xBreite))*xBreite;
                            yyclick=(Math.floor(yclick/yHoehe))*yHoehe;   
                            ctx.fillStyle="green";

                        }
                        else {
                        
                            meldung("Falsch. ==> Go on" ,"18px Arial","red",30,480);  
                            rundeAus=true ;
                            blocken=true;
                            console.log(iterator + zw + zwert);                
                            }
            
                    if (zaehlerTreffer == anzahlBlinks)
                    {
                       treffer++
                        meldung("Treffer  " + treffer ,"18px Arial","black",30,460);  
                        rundeAus=true;
                       
                    }
            }    
} , false); 



function geglicktesFeld(xc,yc){    // xc und yc sind die Koordinaten des Klicks 
    // Liefert deie Nummer des Feldes wenn ein Klick erfolgte.
    var zw;
    for (var i=0;i<spalten*zeilen;i++){

        if ((xCoord[i] < xc) && (xc < xCoord[i] + xBreite ) &&
            (yCoord[i] < yc) && (yc < yCoord[i]+ yHoehe))
            {
            zw=i;      
         
        }
        else{
           // console.log(" i =  " ,i,  "   " + "xC[i]  " + xCoord[i]  + "yc[i]  " + yCoord[i]) ;   
         
        } 
     }
     
  return zw;  
}


function steuerung()
{
    
    ctx.clearRect(30,480-20,300,20);
   ctx.clearRect(xBasis ,460 - 20,300,20);
   
    zaehlerClick=0;
    zaehlerTreffer=0;
    durchLaeufe++;
    
    aufbauMatrix(zeilen,spalten,xBreite,yHoehe);
   
   
   myVar=setInterval(zeige,warteZeit*1000); 
}


function loescheMatrix()
{

    for (i = 0;i<spalten*zeilen;i++){
        ctx.clearRect(xCoord[i],yCoord[i],xBreite,yHoehe);
    }
}

function zeige(){
ctx.clearRect(30,480- 20, 300,20);      
durchLaeufe++;
iterator++;
loescheMatrix();
aufbauMatrix(zeilen,spalten,xBreite,yHoehe);
positionsReihe=auswahlBlinkZellen(zeilen,spalten);
zeichneVorgabeBilder(iterator);

}

canv.addEventListener('click', function(e)
     {
       // verwaltet die Buttons 
        var rect = angetippt(rects, e.offsetX, e.offsetY);        
        if (rect)
        {          
            auswahlButton();         
               }
                }, false);




function abbruch()

    {
        
        loescheMatrix();
        aufbauMatrix(zeilen,spalten,xBreite,yHoehe);
        ctx.clearRect(xBasis,480-30,400,30);   
        meldung("Treffer : " + treffer + "  von :  " +durchLaeufe + "  Durchgängen","18px Arial","red",xBasis,460);
        iterator=3;
        zeichneVorgabeBilder(iterator);
       treffer=0;
        clearInterval(myVar);

    }
 

function angetippt(rects, x, y) {
    var zw;
    var isCollision = false;
    for (let i = 0, len = rects.length; i < len; i++) {
        var left = rects[i].x, right = rects[i].x+rects[i].w;
        var top = rects[i].y, bottom = rects[i].y+rects[i].h;
        if (right >= x
            && left <= x
            && bottom >= y
            && top <= y) {
                isCollision = rects[i];   
                getipptRechteck=i;
          
                }
    }
    return isCollision;
}

function erzeugeDieRechtecke(a,b)
{
       for (var i = a;i <= b; i++) {
        ctx.rect(rects[i].x, rects[i].y, rects[i].w, rects[i].h); 
        ctx.stroke();          
        ctx.fillStyle=rects[i].col;         
       ctx.fillRect(rects[i].x, rects[i].y, rects[i].w, rects[i].h);
      }
}

function rechteckeText()
{ 
    ctx.fillStyle = "black";
    ctx.font = "18px Arial";

    for (var i =0, len = 4; i < len; i++) 
    
    {      
       ctx.fillText(texts[i].na,texts[i].x, texts[i].y);
        
     }
        
}

function plusMinus(sw)
{
  warteZeit=warteZeit + sw; 
  var lg = 20 + ctx.measureText("Anzahl Durchläufe  = " +  maxDurchlaeufe).width 
  meldung("Merkzeit = " +  warteZeit + " Sek. ","18px Arial","black",340 ,490);
}

function auswahlButton()
    {
               switch (getipptRechteck) 
              {
                   
                    case 0:
                        steuerung();                       
                        break;                            
                    case 1:
                        abbruch();                        
                        break;
                    case 2:
                        plusMinus(schrittWeite);                        
                        break;
                     case 3:
                        plusMinus(-schrittWeite);                        
                        break;
                       default:
                        alert("Sorry");
                }             
    }

function meldung(text, schrift,farbe,xm,ym)
   {
     
        var lg = 30 + ctx.measureText(text).width 
        ctx.clearRect(xm,ym,lg,-20);
        ctx.clearRect(xm,ym,lg,-20);
        ctx.fillStyle = farbe;
        ctx.font = schrift;
        ctx.fillText(text, xm ,ym); 
    }

    function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}
function zeichneVorgabeBilder(anz){     
    for (let i=0;i<anz;i++){ 
         zeigBild(pic[blinkReihe[i]], xCoord[positionsReihe[i]], yCoord[positionsReihe[i]],xBreite,yHoehe);     
    } 
}

function zeigBild(a,x,y,w,h)
{
    var img = new Image();
    img.onload = function ()
     {
        ctx.drawImage(img, x,y,w,h);
     }
    img.src = a;
}


function einlesenBilder()
    {
        for (i=0;i< anzahlBilder;i++)
        {
            pic[i]=  "Images/Karten/bg" + i + ".gif" 
          
        } 
    };
</script>
  
<p>Enjoy !</p>

</body>
</html>
