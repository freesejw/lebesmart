<!DOCTYPE html>
<html>
<head>
        <meta charset="utf-8">    
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>

Canvas {
   position: absolute;
   top: 0px;
   left: 0px;
   
   background-color: #efefef;
}
</style>
</head>
<body onload="ladeGame()">
    <canvas id="canvas" width="500" height="650"></canvas>
     
<script>
var canv = document.getElementById("canvas");
var ctx = canv.getContext("2d");
var cW = ctx.canvas.width, cH = ctx.canvas.height;  

var xBreite=75 , yHoehe=99;
var myVar; // für setInterval
var getipptRechteck; // gibt an welcher Button / Rechteck angetippt wurde
var schrittWeite=1,maxDurchlaeufe=4;
var durchLaeufe, treffer;
var bgColor="Lavender";
var auswahlBilder=[],positionsReihe=[];
var vergleichIndex; // dient zur abfrage welcher Button / rechteck angeklickt wurdej
var repeator, warten=false ;
var pic=[], anzahlBilder=52;
var xCoord=[], yCoord=[];
var zeilen = 4, spalten=4;
var xAbstand=30,yAbstand = 80;     // Verschiebt die Matrix nach rechts und unten
var xBasis=20, yBasis1=250, wBasis1=60, hBasis=40, dBasis=40, xtestdis=10, ytextdis=25;
var yBasis2= 540, wBasis2=120, yErhoehung=50; 
var warteZeit=5;
var zaehlerClick;
var zaehlerTreffer;
var iterator=0;

var blocken;


//Rechtecke für die Bilder
var rects = [ {x: xBasis, y: yBasis2 + yErhoehung, w: wBasis2, h: hBasis,col: bgColor},
             {x: (xBasis + wBasis2+ dBasis), y: yBasis2 + yErhoehung , w: wBasis2, h: hBasis,col: bgColor},
             {x: (xBasis + 2 * (wBasis2+ dBasis)), y: yBasis2, w: wBasis2, h: hBasis,col: bgColor},
             {x: (xBasis + 2 * (wBasis2+ dBasis)), y: yBasis2 + yErhoehung, w: wBasis2, h: hBasis,col: bgColor}];
 
var texts = [{na: "Go on", x: xBasis + xtestdis -10, y: yBasis2 + yErhoehung + ytextdis},
            {na: "Abbruch", x: (xBasis + xtestdis +  wBasis2 + dBasis),y: yBasis2 + yErhoehung + ytextdis} ,
            {na: "Mehr Zeit", x: (xBasis + xtestdis + 2 * (wBasis2+ dBasis)),y: yBasis2 + ytextdis },
            {na: "Weniger", x: (xBasis + xtestdis + 2 * (wBasis2+ dBasis)),y: yBasis2 + yErhoehung + ytextdis }];

function ladeGame() 
    {   
        meldung("Übe die Merkspanne","18","Arial","black",40, 25);    
        meldung("Merkzeit = " + warteZeit + " Sek. ", "18","Arial", "black", 340, 510);
        erzeugeButton(0,3);
        aufbauMatrix(zeilen,spalten,xBreite,yHoehe);
        warteZeit=4;
        treffer=0;
        durchLaeufe=0;
        einlesenBilder();
        iterator=3;
        auswahlBilder=shuffleZellen(zeilen,spalten); // enthält die nummern der zu zeigenden Bilder
        positionsReihe=shuffleZellen(zeilen,spalten);// enthält die Nummern der felder, in die die Bilder gezeichnet werden
        console.log(auswahlBilder + "   " + positionsReihe);
        zeichneVorgabeBilder(iterator);
        durchLaeufe=0;
       blocken=false;
    }

 function start()
{
    blocken=true;    
    ctx.clearRect(xBasis,540-25,400,25);// Treffer....T
    ctx.clearRect(xBasis,565-25,300,25); //falsch...
    durchLaeufe=0;
    meldung("Merke dir die jeweils neuen Karten","18","Arial","black",40, 50);    
    loescheMatrix(); //löscht alte Bilderr
    zaehlerClick=0;
    zaehlerTreffer=0;
    aufbauMatrix(zeilen,spalten,xBreite,yHoehe); 
    auswahlBilder=shuffleZellen(zeilen,spalten); // enthält die nummern der zu zeigenden Bilder
    positionsReihe=shuffleZellen(zeilen,spalten);// enthält die Nummern der felder, in die die Bilder gezeichnet werden
    zeichneVorgabeBilder(iterator);

   myVar=setInterval(zeige,warteZeit*1000); 
}
   
function aufbauMatrix(zeilen,spalten,breite,hoehe)
{
   // legt eine Matrix an . In derren Elemente werden nachfolgend die ausgewählten Bilder gezeichnet
    for (let i = 0; i<zeilen; i++)
    {
        var y=yAbstand+hoehe*i;
        for(let j=0;j < spalten;j++)
        {            
            var x=xAbstand + breite*j;  
           //ctx.lineWidth="1";
           // ctx.strokeStyle="red";       
            //ctx.rect(x,y,xBreite,yHoehe);
            //ctx.stroke();
            //linke, obere Koordinaten der Rechtecke
            xCoord.push(x);
            yCoord.push(y);
       
        }
    }   
}  

function shuffleZellen(zeilen,spalten)
{
var zw=[];
for (var i =0; i<zeilen*spalten;i++)
    {
        zw.push(i);    
        
    }
return shuffle(zw);
}

canv.addEventListener('click', function(event)
 {   
    
            xclick = event.clientX; 
            yclick = event.clientY;  
        
    if (xclick>xCoord[0] && (xclick < xCoord[spalten-1]+xBreite)
                        &&  yclick > yCoord[0] &&(yclick<yCoord[zeilen*spalten-1]+yHoehe))
       {
        zaehlerClick++;        
        var zwert = geglicktesFeld(xclick,yclick) // liefert den Index des getippten feldes 
        var zw =positionsReihe[iterator-1];
    
        
            if (zw == zwert)
                {
                    treffer++
                    meldung("Treffer : " + treffer + "  von :  " +durchLaeufe + "  Durchgängen","18","Arial","red",xBasis,540);
                    zaehlerTreffer++;
                    xxclick=(Math.floor(xclick/xBreite))*xBreite;
                    yyclick=(Math.floor(yclick/yHoehe))*yHoehe;   
                    ctx.fillStyle="green";

                }
                else {
                
                    meldung("Falsch. ==> Go on" ,"18","Arial","red",xBasis,565);  
                    abbruch();
                    console.log(iterator + zw + zwert);                
                    }
    
                if (durchLaeufe == spalten*zeilen)
                {
                treffer++
                meldung("Ende","18","Arial","red",xBasis,540);
                                        
                }
            }    
} , false); 



function geglicktesFeld(xc,yc){    // xc und yc sind die Koordinaten des Klicks 
    // Liefert deie Nummer des Feldes wenn ein Klick erfolgte.
    var zw;
    for (var i=0;i<spalten*zeilen;i++){

        if ((xCoord[i] < xc) && (xc < xCoord[i] + xBreite ) &&
            (yCoord[i] < yc) && (yc < yCoord[i]+ yHoehe))
            {
            zw=i;      
         
        }
        else{
           // console.log(" i =  " ,i,  "   " + "xC[i]  " + xCoord[i]  + "yc[i]  " + yCoord[i]) ;   
         
        } 
     }
     
  return zw;  
}


function loescheMatrix()
{
    for (i = 0;i<spalten*zeilen;i++){
        ctx.clearRect(xCoord[i]-5,yCoord[i]-5,xBreite+10,yHoehe+10);
    }
}

function zeige(){
ctx.clearRect(xBasis,480- 20, 300,20);  
ctx.clearRect(xBasis,565-20,300,20)  ;  
durchLaeufe++;
iterator++;
loescheMatrix();
//aufbauMatrix(zeilen,spalten,xBreite,yHoehe);
positionsReihe=shuffleZellen(zeilen,spalten);// enthält die Nummern der felder, in die die Bilder gezeichnet werden
zeichneVorgabeBilder(iterator); // Zeichnet die Bilder an den vorgegebenen Positionen
}

canv.addEventListener('click', function(e)
     {
       // verwaltet die Buttons 
        var rect = angetippt(rects, e.offsetX, e.offsetY);        
        if (rect)
        {          
            auswahlButton();         
               }
                }, false);

function abbruch()

    {
        
        loescheMatrix();
        aufbauMatrix(zeilen,spalten,xBreite,yHoehe);
        ctx.clearRect(xBasis,540-30,400,30);   
        meldung("Treffer : " + treffer + "  von :  " +durchLaeufe + "  Durchgängen","18","Arial","red",xBasis,540);
        iterator=3;
        zeichneVorgabeBilder(iterator);
       treffer=0;
       blocken=false;
        clearInterval(myVar);

    }
 

function angetippt(rects, x, y) {
    var zw;
    var isCollision = false;
    for (let i = 0, len = rects.length; i < len; i++) {
        var left = rects[i].x, right = rects[i].x+rects[i].w;
        var top = rects[i].y, bottom = rects[i].y+rects[i].h;
        if (right >= x
            && left <= x
            && bottom >= y
            && top <= y) {
                isCollision = rects[i];   
                getipptRechteck=i;
          
                }
    }
    return isCollision;
}

function erzeugeButton(a,b)
{
       for (var i = a;i <= b; i++) {
        ctx.rect(rects[i].x, rects[i].y, rects[i].w, rects[i].h); 
        ctx.stroke();          
        ctx.fillStyle=rects[i].col;         
       ctx.fillRect(rects[i].x, rects[i].y, rects[i].w, rects[i].h);
      }
      ctx.fillStyle = "black";
    ctx.font = "18px Arial";

    for (var i =0, len = 4; i < len; i++) 
    
    {      
       ctx.fillText(texts[i].na,texts[i].x, texts[i].y);
        
     } 
}

function plusMinus(sw)
{
  warteZeit=warteZeit + sw; 
  var lg = 20 + ctx.measureText("Anzahl Durchläufe  = " +  maxDurchlaeufe).width 
  meldung("Merkzeit = " + warteZeit + " Sek. ", "18","Arial", "black", 340, 510);
}

function auswahlButton()
    {
               switch (getipptRechteck) 
              {
                   
                    case 0:
                    if(blocken ==false){
                        start(); }                      
                        break;                            
                    case 1:
                    
                        abbruch();                        
                        break;
                    case 2:
                    if (blocken==false){
                        plusMinus(schrittWeite); }                       
                        break;
                     case 3:
                     if (blocken ==false ){
                        plusMinus(-schrittWeite);}
                        break;
                       default:
                        alert("Sorry");
                }             
    }
    function meldung(text, schriftGroesse,schriftTyp,farbe,xm,ym)
   {
        var lg = 10 + ctx.measureText(text).width 
        ctx.clearRect(xm, ym-schriftGroesse+2,lg,25);
        ctx.fillStyle = farbe;        
        ctx.font = schriftGroesse + "px "+ schriftTyp;
        ctx.fillText(text, xm ,ym); 
    }
  
function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}
function zeichneVorgabeBilder(anz){     
    for (let i=0;i<anz;i++){ 
         zeigBild(pic[auswahlBilder[i]], xCoord[positionsReihe[i]], yCoord[positionsReihe[i]],xBreite-5,yHoehe-5);
         ctx.strokeRect(xCoord[positionsReihe[i]], yCoord[positionsReihe[i]],xBreite,yHoehe);     
    } 
}

function zeigBild(a,x,y,w,h)
{
    var img = new Image();
    img.onload = function ()
     {
        ctx.drawImage(img, x,y,w,h);
     }
    img.src = a;
}


function einlesenBilder()
    {
        for (i=0;i< anzahlBilder;i++)
        {
            pic[i]=  "Images/Karten/bg" + i + ".gif" 
          
        } 
    };
</script>
  


</body>
</html>
