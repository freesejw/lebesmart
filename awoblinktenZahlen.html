<!DOCTYPE html>
<html>
<head>
        <meta charset="utf-8">     
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>

Canvas {
   position: absolute;
   top: 0px;
   left: 0px;
   border: 1px red solid;
   background-color: #FFEFDB;
}
</style>
</head>
<body onload="ladeGame()">
    <canvas id="canvas" width="500" height="600"></canvas>
     
<script>
var canv = document.getElementById("canvas");
var ctx = canv.getContext("2d");
var cW = ctx.canvas.width, cH = ctx.canvas.height;  

var xBreite=60 , yHoehe=60;
var myVar; // für setInterval
var getipptRechteck; // gibt an welcher Button / Rechteck angetippt wurde
var schrittWeite=1,maxDurchlaeufe=4;
var durchLaeufe, treffer;
var bgColor="lightblue";
var blinkReihe=[];
var vergleichIndex; // dient zur abfrage welcher Button / rechteck angeklickt wurdej
var repeator, warten=false ;

var xCoord=[], yCoord=[];
var zeilen = 5, spalten=5;
var xAbstand=30,yAbstand = 70;     // Verschiebt die Matrix nach rechts und unten
var xBasis=20, yBasis1=250, wBasis1=60, hBasis=40, dBasis=40, xtestdis=10, ytextdis=25;
var yBasis2= 460, wBasis2=120, yErhoehung=50; 

var zaehlerClick;
var zaehlerTreffer;
var iterator=-1;
var anzahlBlinks=4;
var zahlen=[];


//Rechtecke für die Bilder
var rects = [ {x: xBasis, y: yBasis2, w: wBasis2, h: hBasis,col: bgColor},
             {x: (xBasis + wBasis2+ dBasis), y: yBasis2, w: wBasis2, h: hBasis,col: bgColor},
             {x: (xBasis + 2 * (wBasis2+ dBasis)), y: yBasis2, w: wBasis2, h: hBasis,col: bgColor},
             {x: (xBasis + 2 * (wBasis2+ dBasis)), y: yBasis2 + yErhoehung, w: wBasis2, h: hBasis,col: bgColor}];
 
var texts = [{na: "Go on", x: xBasis + xtestdis -10, y: yBasis2 + ytextdis},
            {na: "Abbruch", x: (xBasis + xtestdis +  wBasis2 + dBasis),y: yBasis2 + ytextdis} ,
            {na: "Durchläufe +", x: (xBasis + xtestdis + 2 * (wBasis2+ dBasis)),y: yBasis2 + ytextdis },
            {na: "Durchläufe -", x: (xBasis + xtestdis + 2 * (wBasis2+ dBasis)),y: yBasis2 + yErhoehung + ytextdis }];

function ladeGame() 
    {   
        meldung("Übe die Merkspanne","18px Arial","black",40, 25);    
        
        erzeugeDieRechtecke(0,3);
        rechteckeText();  // und hier mit Text versehen falls keine bilder genommen werden 
        aufbauMatrix(zeilen,spalten,xBreite,yHoehe);
        treffer=0;
        durchLaeufe=0;
       iterator=-1;
     
    }
   
    function aufbauMatrix(zeilen,spalten,breite,hoehe)
{
   // legt eine Matrix an . In derren Elemente werden nachfolgend die ausgewählten Bilder gezeichnet
    for (let i = 0; i<zeilen; i++)
    {
        var y=yAbstand+hoehe*i;
        for(let j=0;j < spalten;j++)
        {            
            var x=xAbstand + breite*j;  
            ctx.lineWidth="2";
            ctx.strokeStyle="red";       
            ctx.rect(x,y,xBreite,yHoehe);            
            ctx.stroke();

            ctx.font = "20pxArial";
            ctx.fillStyle="blue";
            let zw=random(9);
            ctx.fillText(zw,x+5,y+20);
            //linke, obere Koordinaten der Rechtecke
            xCoord.push(x);
            yCoord.push(y);
            zahlen.push(zw)
           
        }
    }  
    console.log("zahlen " + zahlen);
       
}  

function auswahlBlinkZellen(zeilen,spalten)
{
var zw=[];
for (var i =0; i<zeilen*spalten;i++)
    {
        zw.push(i);    
        
    }
return shuffle(zw);
}

canv.addEventListener('click', function(event)
 {   
    
            xclick = event.clientX; 
            yclick = event.clientY;  
        
    if (xclick>xCoord[0] && (xclick < xCoord[spalten-1]+xBreite)
                        &&  yclick > yCoord[0] &&(yclick<yCoord[zeilen*spalten-1]+yHoehe))
       {
            zaehlerClick++;        
        
            var zwert = geglicktesFeld(xclick,yclick) // liefert den Index des getippten feldes 
            var zw =blinkReihe[zaehlerClick];

               
                    if (zw == zwert)
                        {
                            zaehlerTreffer++;
                            xxclick=(Math.floor(xclick/xBreite))*xBreite;
                            yyclick=(Math.floor(yclick/yHoehe))*yHoehe;   
                            ctx.fillStyle="green";

                            ctx.fillRect(xCoord[blinkReihe[zaehlerClick]] ,yCoord[blinkReihe[zaehlerClick]] ,xBreite,yHoehe);
                        
                        
                        }
                        else {
                        
                            meldung("Falsch. ==> Go on" ,"18px Arial","red",30,420);  
                            rundeAus=true ;
                            blocken=true;
                                            
                            }
            
                    if (zaehlerTreffer == anzahlBlinks)
                    {
                       treffer++
                        meldung("Treffer  " + treffer ,"18px Arial","black",30,420);  
                        rundeAus=true;
                       
                    }
            }    
} , false); 



function geglicktesFeld(xc,yc){    // xc und yc sind die Koordinaten des Klicks 
    // Liefert deie Nummer des Feldes wenn ein Klick erfolgte.
    var zw;
    for (var i=0;i<spalten*zeilen;i++){

        if ((xCoord[i] < xc) && (xc < xCoord[i] + xBreite ) &&
            (yCoord[i] < yc) && (yc < yCoord[i]+ yHoehe))
            {
            zw=i;      
         
        }
        else{
           // console.log(" i =  " ,i,  "   " + "xC[i]  " + xCoord[i]  + "yc[i]  " + yCoord[i]) ;   
         
        } 
     }
     
  return zw;  
}


function steuerung()
{
    ctx.clearRect(30,420-30,400,35);
    ctx.clearRect(xBasis ,370,400,30);
    iterator=-1; 
    zahlen=[];
    zaehlerClick=0;
    zaehlerTreffer=0;
    durchLaeufe++;
    loescheMatrix();
    aufbauMatrix(zeilen,spalten,xBreite,yHoehe);
    blinkReihe=auswahlBlinkZellen(zeilen,spalten);
    myVar=setInterval(zeige,1000); 
}


function loescheMatrix()
{

    for (i = 0;i<spalten*zeilen;i++){
        ctx.clearRect(xCoord[i],yCoord[i],xBreite,yHoehe);
    }
}

function zeige(){

iterator++;
//ctx.fillStyle='rgba(255,0,0,0.25)'; 
ctx.globalAlpha = 0.1;
ctx.fillStyle = "blue";
console.log("blinkreihe  " +blinkReihe);
            console.log( "Iterator" +  iterator);
            console.log("zahlen 2  " + zahlen);
ctx.fillRect(xCoord[blinkReihe[iterator]],yCoord[blinkReihe[iterator]],xBreite,yHoehe);
if (iterator>0 && iterator<=anzahlBlinks)
    {
    ctx.clearRect(xCoord[blinkReihe[iterator-1]],yCoord[blinkReihe[iterator-1]],xBreite,yHoehe);
                ctx.lineWidth="1";
                ctx.strokeStyle="red"; 

                ctx.rect(xCoord[blinkReihe[iterator-1]],yCoord[blinkReihe[iterator-1]],xBreite,yHoehe);
                ctx.stroke();
                ctx.fillStyle="blue";
            let zw=random(9);
           
            ctx.fillText(zahlen[blinkReihe[iterator-1]],300,300);
            ctx.fillText("232323",xCoord[blinkReihe[iterator-1]] + 5,yCoord[blinkReihe[iterator-1]]+20);
   
   ctx.fillText(zahlen[blinkReihe[iterator-1]],390,230);
    }
    if (iterator>anzahlBlinks)
    {
        ctx.clearRect(xCoord[blinkReihe[iterator]],yCoord[blinkReihe[iterator]],xBreite,yHoehe);
        ctx.fillStyle="green";
        ctx.font="40px Arial";
        console.log("x coord  " +xCoord[blinkReihe[iterator-1]])
        ctx.fillText(zahlen[blinkReihe[iterator]],xCoord[blinkReihe[iterator-1]] + 5,yCoord[blinkReihe[iterator-1]]+20);
        clearInterval(myVar);
    }            
    
}

canv.addEventListener('click', function(e)
     {
       // verwaltet die Buttons 
        var rect = angetippt(rects, e.offsetX, e.offsetY);        
        if (rect)
        {          
            auswahlButton();         
               }
                }, false);




function abbruch()

    {
        
       
        ctx.clearRect(xBasis,420-30,400,30);   
        meldung("Treffer : " + treffer + "  von :  " +durchLaeufe + "  Durchgängen","18px Arial","red",xBasis,400);
        clearInterval(myVar);
    }
 
function random(max)
          {
            return Math.floor((Math.random() *max));
          }

function angetippt(rects, x, y) {
    var zw;
    var isCollision = false;
    for (let i = 0, len = rects.length; i < len; i++) {
        var left = rects[i].x, right = rects[i].x+rects[i].w;
        var top = rects[i].y, bottom = rects[i].y+rects[i].h;
        if (right >= x
            && left <= x
            && bottom >= y
            && top <= y) {
                isCollision = rects[i];   
                getipptRechteck=i;
          
                }
    }
    return isCollision;
}

function erzeugeDieRechtecke(a,b)
{
       for (var i = a;i <= b; i++) {
        ctx.rect(rects[i].x, rects[i].y, rects[i].w, rects[i].h); 
        ctx.stroke();          
        ctx.fillStyle=rects[i].col;         
       ctx.fillRect(rects[i].x, rects[i].y, rects[i].w, rects[i].h);
      }
}

function rechteckeText()
{ 
    ctx.fillStyle = "black";
    ctx.font = "18px Arial";

    for (var i =0, len = 4; i < len; i++) 
    
    {      
       ctx.fillText(texts[i].na,texts[i].x, texts[i].y);
        
     }
        
}

function plusMinus(sw)
{
  anzahlBlinks=anzahlBlinks + sw; 
  var lg = 20 + ctx.measureText("Anzahl Durchläufe  = " +  maxDurchlaeufe).width 
  meldung("Anzahl Blinks = " +  anzahlBlinks,"18px Arial","black",xBasis ,390);
}

function auswahlButton()
    {
               switch (getipptRechteck) 
              {
                   
                    case 0:
                        steuerung();                       
                        break;                            
                    case 1:
                        abbruch();                        
                        break;
                    case 2:
                        plusMinus(schrittWeite);                        
                        break;
                     case 3:
                        plusMinus(-schrittWeite);                        
                        break;
                       default:
                        alert("Sorry");
                }             
    }

function meldung(text, schrift,farbe,xm,ym)
   {
     
        var lg = 30 + ctx.measureText(text).width 
        ctx.clearRect(xm,ym,lg,-20);
        ctx.clearRect(xm,ym,lg,-20);
        ctx.fillStyle = farbe;
        ctx.font = schrift;
        ctx.fillText(text, xm ,ym); 
    }

    function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}



</script>
  
<p>Enjoy !</p>

</body>
</html>
