<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">    
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href='https://fonts.googleapis.com/css?family=Comfortaa' rel='stylesheet'>
<link href="css/standard.css" rel="stylesheet">
<script src="js/standard.js"></script>

<style></style>
</head>
<body onload="ladeGame()">
<canvas id="canvas" width="500" height="600"></canvas>

<script>
var myVar;     
var startTime,elapsedTime,zeiten="";
var canv = document.getElementById("canvas");
var ctx = canv.getContext("2d");
var zeiten=[];
var schnitt;
var xCoord=[], yCoord=[];
var operand;
var rechenSchritte=5, schrittWeite=1,string;
var durchLaeufe,richtig;
var ergebnis, ergebnisIndex;
var summe=0; 
var xBasis=20, yBasis1=220, wBasis1=40, hBasis=40, dBasis=40, xtextdis=20, ytextdis=25;
var yBasis2= 500, wBasis2=120, yErhoehung=50; 
var bgCol="5a617b";
var breite=20,hoehe=40,xAbstand=10,y =140, xDist=10,yDist=25;
var stopploesung;
var stoppstarten;
var sekunden;
var timer = new stoppenZeit(drawTime);
var xUhrPosition=180;
var yUhrPosition=90;

var rects = [{x: xBasis, y: yBasis2 + yErhoehung, w: wBasis2, h: hBasis,col1: "#82CE86",col2:"#82CE86"},
             {x: (xBasis + wBasis2+ dBasis), y: yBasis2 + yErhoehung, w: wBasis2, h: hBasis,col1: "#7f7fff",col2: "#7f7fff"},
             {x: (xBasis + 2 *( wBasis2+ dBasis)), y: yBasis2, w: wBasis2, h: hBasis,col1: "#5a617b",col2: "#5a617b"},             
             {x: (xBasis + 2 * (wBasis2+ dBasis)), y: yBasis2 + yErhoehung, w: wBasis2, h: hBasis,col1: "#5a617b",col2: "#5a617b"},

// Lösungs Alternativen  
             {x: xBasis, y: yBasis1, w: wBasis1, h: hBasis,col1: bgCol},
             {x: (xBasis + wBasis1+ dBasis), y: yBasis1, w: wBasis1, h: hBasis,col1: bgCol},
             {x: (xBasis + 2 * (wBasis1+ dBasis)), y: yBasis1, w: wBasis1, h: hBasis,col1: bgCol},
             {x: (xBasis + 3 * (wBasis1+ dBasis)), y: yBasis1, w: wBasis1, h: hBasis,col1: bgCol},
             {x: (xBasis + 4 * (wBasis1+ dBasis)), y: yBasis1, w: wBasis1, h: hBasis,col1: bgCol},
             {x: (xBasis + 5 * (wBasis1+ dBasis)), y: yBasis1, w: wBasis1, h: hBasis,col1: bgCol}];

var texts =[{na:  String.fromCharCode(9655)+ "  Go on", x: xBasis + xtextdis -10, y: yBasis2 + ytextdis+yErhoehung,},
           {na: String.fromCharCode(9673)+"  Lösung", x: (xBasis + xtextdis +  wBasis2 + dBasis),y: yBasis2 + ytextdis + yErhoehung} ,
           {na: String.fromCharCode(43)+"  Ziffern", x: (xBasis + 15+ 2 * (wBasis2+ dBasis)),y: yBasis2 + ytextdis },
           {na: String.fromCharCode(45)+"  Ziffern", x: (xBasis + 15 + 2 * (wBasis2+ dBasis)),y: yBasis2 + yErhoehung + ytextdis }];

function ladeGame()
    {
        // Die Kettenrechnung befindet sich bei yBasis1 + ytextdis 
       
        meldung("Verbessere deine Rechen - Geschwindigkeit","bold","20",schriftArt,"#5a617b",34,40 ); 
        meldung( "3 + 4 *  .......  =   ?","bold","18",schriftArt,"#5a617b",165,220);
        //meldung("Anzahl Ziffern = " + rechenSchritte,"normal","16",schriftArt,"#5a617b",(xBasis + 2 * (wBasis2+ dBasis)) ,yBasis1+ytextdis+230);  
        meldung("Anzahl Ziffern = " + rechenSchritte,"normal","16",schriftArt,"#5a617b",(xBasis + 2 * (wBasis2+ dBasis)) ,yBasis1+ytextdis+230);   
        roundedButton(4);
        buttonText();        
        richtig=0;
        durchLaeufe=0;
        stopploesung = true;
        stoppstarten = false;
    }


function start()
    {   
        
        meldung("Klick die obige Zahl an, die dem Ergebnis entspricht","normal","16",schriftArt,"#5a617b",xBasis,yBasis1+ytextdis+80);
        meldung("Anzahl Richtige :  " + richtig,"bold","16",schriftArt,"#5a617b",xBasis, yBasis1+ytextdis+150);  
        ctx.clearRect(xBasis,yBasis1+ytextdis+250, 320, -25);   // Löschen Lösungsanzeige
        ctx.clearRect(xBasis, 220-25,500,25); // löscht 3+ 4 *... Anzeige
        ctx.clearRect(xBasis-10, yBasis1-30,500,ytextdis+50); // löscht die möglichen Lösungen
        ctx.clearRect(xCoord[1],yCoord[1]-30,500,130);        
        aufbauZeile(rechenSchritte,breite,hoehe);
        vergleichsZahlen();
        startTime = Date.now();
        //zsecs = 0, secs = 0, minu = 0, hrs = 0;
        timer.start();
        stopploesung = false;        
        stoppstarten=true;
    }


function aufbauZeile(ele,breite,hoehe)
{
   // legt eine Zeile an . In derren Elemente werden nachfolgend die zahlen und opranden  gezeichnet
            var rr, xx,oo;            
            var anzahlZahlen=ele;
            var anzahlOperanden=ele-1;
            var anzahlFelder=ele*2 + 1 + 2; // + 2 sind für = ergebnis
            var operanden=["+" , "+", "-", "-" ,"+" , "+", "-", "-" ,"*", "/"]; // Die Operanden MÜSSEN ohne Leerzeichen eingegeben werden.
            string="";
            xCoord=[];
            yCoord=[];


    for (var i = 0; i<anzahlFelder; i++)
    {        
            var x=breite*i;              
            xCoord.push(x);
            yCoord.push(y);

    }
  
    for ( var i = 0 ; i <anzahlZahlen;i++)
    {
            ctx.fillStyle="#5a617b";
            ctx.font= "bolder 18px Arial" + " " + schriftArt;            
          
            if (i < anzahlOperanden)
            {
                rr = 1 + random(15); 
                let isDivision = (oo==="/")
                let isLargerOne = i>0
                
                if(isDivision && isLargerOne)
                {
                   
                    // Findet alle Zahlen aus dem Bereich 1 bis xx - 1, für die die Moduleoperation null ergibt.
                    // Aus der Liste dieser Zahlen wird dann zufällig eine ausgewählt.

                    var moeglichkeiten = []
                    for(var j = Math.max(1, xx - 1); j >= 1; j--) { // das Math.max ist wichtig für den Fall, dass xx eins ist.+

                        if(xx%j == 0) 
                        {
                            moeglichkeiten.push(j)
                        }
                    }

                        let wahl = random(moeglichkeiten.length)
                        rr = moeglichkeiten[wahl]
                     }
                string=string + rr;
                ctx.fillText(rr,xCoord[i*2] +xAbstand *2,yCoord[i*2]+yDist+10);  
                xx =ergebnisKette(string);                
                oo=operanden[random(operanden.length)].trim(); 
                if(i==anzahlOperanden-1) 
               // Als letzter Operand wird das * und / ausgeschlossen
                    oo= oo=operanden[random(operanden.length-2)].trim(); 
            
                ctx.fillStyle="red"; 
               ctx.font= "bolder 18px Arial"; 
              
                ctx.fillText(oo,xCoord[i*2+1]+xAbstand * 2 ,yCoord[i*2+1]+yDist+10);
                string=string +oo.valueOf();  
              
            }
            
            else
            {             
            rr =1+random(9); 
            string=string + rr;  
            ctx.fillText(rr,xCoord[i*2] +xAbstand *2,yCoord[i*2]+yDist+10); // zeigt die letzte Zahl an

            
                ctx.fillText("=",xCoord[i*2+1]+xAbstand *2 + xDist,yCoord[i*2+1]+yDist +10); 
                //var erg=eval(string); Liefert Lösung incl Rechenregeln
                ergebnis=ergebnisKette(string);               
                ctx.fillText("?",xCoord[i*2+2]+xAbstand *2 + xDist,yCoord[i*2+2]+yDist+10);      
            }
        
    }

}
 
function vergleichsZahlen()
{
   //Liefert die Zahlen des möglichen Ergebnisses
   // In  zz[ergebnisIndex] ist das richtige Ergerbnis gespeichert
   // Die Position wird per Zufall generiert
   
    var zz=[];
    for (var i=0;i<6;i++)
    {
        var min = ergebnis - 12;
        var max = ergebnis + 12;
        zz[i]=getRndInteger(min,max);
        if (zz[i]==ergebnis){i=i-1;}   
    }

        ergebnisIndex=getRndInteger(0,5);
        zz[ergebnisIndex]  = ergebnis; 

            ctx.fillStyle="red"; 
            ctx.font= "16px" + " " + schriftArt;      
            ctx.fillText(zz[0],xBasis +8 ,yBasis1+ ytextdis); 
            ctx.fillText(zz[1],xBasis + 8 + wBasis1+dBasis,yBasis1+ytextdis); 
            ctx.fillText(zz[2],(xBasis +8 +  2 * (wBasis1+ dBasis)),yBasis1+ytextdis);
            ctx.fillText(zz[3],(xBasis + 8 + 3 * (wBasis1+ dBasis)),yBasis1+ ytextdis);
            ctx.fillText(zz[4],(xBasis + 8 + 4 * (wBasis1+ dBasis)),yBasis1 +ytextdis );
            ctx.fillText(zz[5],(xBasis + 8 + 5 * (wBasis1+ dBasis)),yBasis1 +ytextdis );
            for(var i=0;i<6;i++)
            {
            filledCircle(rects[4+i].x+20, rects[4+i].y+20,30,0,2,Math.PI);
            }
}
 
  function ergebnisKette(kette)
   {
        var zw=kette.match(/(\d+)|([\+\*\-\/\:])/g).reduce((accu, curr) => isNaN(curr) ? 
        (accu + (curr === ':' ? '/' : curr)) : eval(accu + curr));  
         return zw;
   }  

function loesung()
    {
        ctx.clearRect(xBasis, 380, 500, -24);                       
        meldung("Lösung : " + string + "  = "+ ergebnis,"normal","16",schriftArt,"#ea2867",xBasis,yBasis1+ytextdis+250);  
       timer.stop();
    }


 canv.addEventListener('click', function(e)
     {       
        var rect = angetippt(rects, e.offsetX, e.offsetY);
        if (rect) 
        {
          auswahlButton();  
               
        }}, false);


function vergleich(a)
{
    if(a==ergebnisIndex+4)
        {
           richtig++;
            meldung(( "Anzahl Richtige :  " + richtig) +  " bei " + durchLaeufe + " Durchläufe","bold","16",schriftArt,"#5a617b",xBasis, yBasis1+ytextdis+150);
                 
            zeiten.push( sekunden); 

            var ausdruck=zeiten ;
           
            for (var i= 0;i<zeiten.length-1;i++);
               {
               console.log("  1  " + summe );   
                summe+=zeiten[i];               
            }
            var schnitt=(  summe/richtig); 
            schnitt=Math.floor(schnitt*10)/10;
            if(ausdruck.length>10){ausdruck.shift();}        
            meldung(( "Zeiten / Durchlauf ( Sek. ) :  " + ausdruck ),"normal","16",schriftArt,"#5a617b",xBasis, yBasis1+ytextdis+185);
            if (richtig>0){
            //meldung(( "Durchschnitt ( Sek. ) :  "  + schnitt),"normal","16",schriftArt,"#5a617b",xBasis, yBasis1+ytextdis+215);
            meldung(( "Durchschnitt ( Sek. ) :  "  + schnitt),"normal","16",schriftArt,"#5a617b",xBasis, yBasis1+ytextdis+215);           
            }
        }
    else 
        {
            meldung(( "Anzahl Richtige :  " + richtig) +  " bei " + durchLaeufe + " Durchläufe","bold","16",schriftArt,"#5a617b",xBasis, yBasis1+ytextdis+150);
        }
        
           
    }


function auswahlButton()

    {        
        switch (getipptRechteck) 
                {
                    case 0:                                         
                    if(!stoppstarten)
                            {    
                                start();
                                stoppstarten=true;
                            }    
                        break;
                    case 1:
                        if(!stopploesung)
                            {
                                ctx.clearRect(xUhrPosition-20+-5,yUhrPosition-30+-5,210,100);//löscht Uhr
                                loesung();
                                stoppstarten=false;
                                timer.stop();    
                            }                                        
                        break;
                    case 2:
                        rechenSchritte= plusMinus(rechenSchritte,1,1,11); 
                        meldung("Anzahl Ziffern = " + rechenSchritte,"normal","16",schriftArt,"#5a617b",(xBasis + 2 * (wBasis2+ dBasis)) ,yBasis1+ytextdis+230);                          
                        //start();                          
                        break;
                    case 3:
                        rechenSchritte= plusMinus(rechenSchritte,-1,1,11); 
                        meldung("Anzahl Ziffern = " + rechenSchritte,"normal","16",schriftArt,"#5a617b",(xBasis + 2 * (wBasis2+ dBasis)) ,yBasis1+ytextdis+230);   
                        //start();                          
                        break;
                     case 4:
                     case 5:
                     case 6:
                     case 7:
                     case 8:   
                     case 9:
                        stoppstarten=false;
                        ctx.clearRect(xUhrPosition-20+-5,yUhrPosition-30+-5,210,100);// Löscht Uhr
                        durchLaeufe++;                       
                        vergleich(getipptRechteck);  
                        timer.stop();
                        break;  
                                     
                    default:
                       alert("ups");
                }             
    }

function getRndInteger(min, max) {
  return Math.floor(Math.random() * (max - min + 1) ) + min;
}

function drawTime(zsecs, secs, minu) {
    uhrAnzeige(xUhrPosition,yUhrPosition,minu,secs,zsecs) ;  
    sekunden=secs;
    
}
function roundedButton(a)
{
       for (var i = 0; i < a; i++) {       
       ctx.fillStyle=rects[i].col1;
       roundedRect(rects[i].x, rects[i].y, rects[i].w, rects[i].h,10);
      // ctx.fillStyle=rects[i].col2 , 
       //roundedRect(rects[i].x+5, rects[i].y+5, rects[i].w-10, rects[i].h-10,10);       
      }
}
      
        
</script>

</body>
</html>
