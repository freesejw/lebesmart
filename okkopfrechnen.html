<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">    
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>

Canvas {
   position: absolute;
   top: 20px;
   left: 20px;
   background-color: #e6e6e6;
}
</style>
</head>
<body onload="ladeGame()">
<canvas id="canvas" width="500" height="600"></canvas>

<script>
var startTime,elapsedTime,zeiten="";
var canv = document.getElementById("canvas");
var ctx = canv.getContext("2d");
var zeiten=[];
var schnitt;
var xCoord=[], yCoord=[];
var operand;
var bgColor="Lavender";
var rechenSchritte=5, schrittWeite=1,string;
var durchLaeufe,richtig;
var ergebnis, ergebnisIndex;
var summe=0; 
var xBasis=20, yBasis1=220, wBasis1=40, hBasis=40, dBasis=40, xtextdis=20, ytextdis=25;
var yBasis2= 500, wBasis2=120, yErhoehung=50; 

var breite=20,hoehe=40,xAbstand=10,y =140, xDist=10,yDist=25;

var rects = [{x: xBasis, y: yBasis2, w: wBasis2, h: hBasis,col: bgColor},
             {x: (xBasis + wBasis2+ dBasis), y: yBasis2, w: wBasis2, h: hBasis,col: bgColor},
             {x: (xBasis + 2 *( wBasis2+ dBasis)), y: yBasis2, w: wBasis2, h: hBasis,col: bgColor},             
             {x: (xBasis + 2 * (wBasis2+ dBasis)), y: yBasis2 + yErhoehung, w: wBasis2, h: hBasis,col: bgColor},

// Lösungs Alternativen  
             {x: xBasis, y: yBasis1, w: wBasis1, h: hBasis,col: bgColor},
             {x: (xBasis + wBasis1+ dBasis), y: yBasis1, w: wBasis1, h: hBasis,col: bgColor},
             {x: (xBasis + 2 * (wBasis1+ dBasis)), y: yBasis1, w: wBasis1, h: hBasis,col: bgColor},
             {x: (xBasis + 3 * (wBasis1+ dBasis)), y: yBasis1, w: wBasis1, h: hBasis,col: bgColor},
             {x: (xBasis + 4 * (wBasis1+ dBasis)), y: yBasis1, w: wBasis1, h: hBasis,col: bgColor},
             {x: (xBasis + 5 * (wBasis1+ dBasis)), y: yBasis1, w: wBasis1, h: hBasis,col: bgColor}];

var texts =[{na: "Go on", x: xBasis + xtextdis -10, y: yBasis2 + ytextdis},
           {na: "Lösung", x: (xBasis + xtextdis +  wBasis2 + dBasis),y: yBasis2 + ytextdis} ,
           {na: "Mehr Ziffern", x: (xBasis + 10+ 2 * (wBasis2+ dBasis)),y: yBasis2 + ytextdis },
           {na: "Weniger", x: (xBasis + xtextdis + 2 * (wBasis2+ dBasis)),y: yBasis2 + yErhoehung + ytextdis }];

function ladeGame()
    {
        // Die Kettenrechnung befindet sich bei yBasis1 + ytextdis 
        
        meldung("Verbessere deine Rechen - Geschwindigkeit","20px Arial","blue",60,65 ); 
        meldung( "3 + 4 *  ....... = ?","20px Arial","blue",65,120);
        meldung("Anzahl Ziffern = " + rechenSchritte,"18px Arial","blue",(xBasis + 2 * (wBasis2+ dBasis)) ,yBasis1+ytextdis+230);  
        buttonErstellen()
        buttonText();
        //aufbauZeile(rechenSchritte,breite,hoehe);
        ctx.clearRect(xBasis-10, 240-30,500,ytextdis+50);
        richtig=0;
        durchLaeufe=0;
    }


function start()
    {   
        meldung("Welcher Ergebnisvorschlag ist richtig","18px Arial","blue",xBasis, yBasis1+ytextdis+50);       
        meldung("Klick die Zahl an, die dem Ergebnis entspricht","16px Arial","blue",xBasis,yBasis1+ytextdis+80);
        meldung("Anzahl Richtige :  " + richtig,"18px Arial","blue",xBasis, yBasis1+ytextdis+150);   
        //meldung("Anzahl Ziffern = " + rechenSchritte,"18px Arial","blue",(xBasis + 2 * (wBasis2+ dBasis)) ,yBasis1+ytextdis+230);  

        ctx.clearRect(xBasis,yBasis1+ytextdis+120, 500, -25);   // Löschen Lösungsanzeige
        ctx.clearRect(xBasis, 120-25,500,25); // löscht 3+ 4 *... Anzeige
        ctx.clearRect(xBasis-10, yBasis1-30,500,ytextdis+50); // löscht die möglichen Lösungen
        ctx.clearRect(xCoord[1],yCoord[1]-30,500,130);        
        aufbauZeile(rechenSchritte,breite,hoehe);
        vergleichsZahlen();
        startTime = Date.now();
        
    }


function aufbauZeile(ele,breite,hoehe)
{
   // legt eine Zeile an . In derren Elemente werden nachfolgend die zahlen und opranden  gezeichnet
            var rr, xx,oo;            
            var anzahlZahlen=ele;
            var anzahlOperanden=ele-1;
            var anzahlFelder=ele*2 + 1 + 2; // + 2 sind für = ergebnis
            var operanden=["+" , "+", "-", "-" ,"+" , "+", "-", "-" ,"*", "/"]; // Die Operanden MÜSSEN ohne Leerzeichen eingegeben werden.
            string="";
            xCoord=[];
            yCoord=[];


    for (var i = 0; i<anzahlFelder; i++)
    {        
            var x=breite*i;              
            xCoord.push(x);
            yCoord.push(y);

    }
  
    for ( var i = 0 ; i <anzahlZahlen;i++)
    {
            ctx.fillStyle="blue";
            ctx.font= "20px Arial";            
          
            if (i < anzahlOperanden)
            {
                rr = 1 + random(9); 
                let isDivision = (oo==="/")
                let isLargerOne = i>0
                
                if(isDivision && isLargerOne)
                {
                   
                    // Findet alle Zahlen aus dem Bereich 1 bis xx - 1, für die die Moduleoperation null ergibt.
                    // Aus der Liste dieser Zahlen wird dann zufällig eine ausgewählt.

                    var moeglichkeiten = []
                    for(var j = Math.max(1, xx - 1); j >= 1; j--) { // das Math.max ist wichtig für den Fall, dass xx eins ist.+

                        if(xx%j == 0) 
                        {
                            moeglichkeiten.push(j)
                        }
                    }

                        let wahl = random(moeglichkeiten.length)
                        rr = moeglichkeiten[wahl]
                     }
                string=string + rr;
                ctx.fillText(rr,xCoord[i*2] +xAbstand *2,yCoord[i*2]+yDist+30);  
                xx =ergebnisKette(string);                
                oo=operanden[random(operanden.length)].trim(); 
                if(i==anzahlOperanden-1) 
               // Als letzter Operand wird das * und / ausgeschlossen
                    oo= oo=operanden[random(operanden.length-2)].trim(); 
            
                ctx.fillStyle="red"; 
                ctx.font= "18px Arial";  
                ctx.fillText(oo,xCoord[i*2+1]+xAbstand * 2 ,yCoord[i*2+1]+yDist+30);
                string=string +oo.valueOf();  
              
            }
            
            else
            {             
            rr =1+random(9); 
            string=string + rr;  
            ctx.fillText(rr,xCoord[i*2] +xAbstand *2,yCoord[i*2]+yDist+30); // zeigt die letzte Zahl an

            
                ctx.fillText("=",xCoord[i*2+1]+xAbstand *2 + xDist,yCoord[i*2+1]+yDist +30); 
                //var erg=eval(string); Liefert Lösung incl Rechenregeln
                ergebnis=ergebnisKette(string);               
                ctx.fillText("?",xCoord[i*2+2]+xAbstand *2 + xDist,yCoord[i*2+2]+yDist+30);      
            }
        
    }

}
 
function vergleichsZahlen()
{
   //Liefert die Zahlen des möglichen Ergebnisses
   // In  zz[ergebnisIndex] ist das richtige Ergerbnis gespeichert
   // Die Position wird per Zufall generiert
   
    var zz=[];
    for (i=0;i<6;i++)
    {
        var min = ergebnis - 12;
        var max = ergebnis + 12;
        zz[i]=getRndInteger(min,max);
        if (zz[i]==ergebnis){i=i-1;}   
    }

        ergebnisIndex=getRndInteger(0,5);
        zz[ergebnisIndex]  = ergebnis; 

            ctx.fillStyle="red"; 
            ctx.font= "20px Arial";      
            ctx.fillText(zz[0],xBasis +8 ,yBasis1+ ytextdis); 
            ctx.fillText(zz[1],xBasis + 8 + wBasis1+dBasis,yBasis1+ytextdis); 
            ctx.fillText(zz[2],(xBasis +8 +  2 * (wBasis1+ dBasis)),yBasis1+ytextdis);
            ctx.fillText(zz[3],(xBasis + 8 + 3 * (wBasis1+ dBasis)),yBasis1+ ytextdis);
            ctx.fillText(zz[4],(xBasis + 8 + 4 * (wBasis1+ dBasis)),yBasis1 +ytextdis );
            ctx.fillText(zz[5],(xBasis + 8 + 5 * (wBasis1+ dBasis)),yBasis1 +ytextdis );
}
 
  function ergebnisKette(kette)
   {
        var zw=kette.match(/(\d+)|([\+\*\-\/\:])/g).reduce((accu, curr) => isNaN(curr) ? 
        (accu + (curr === ':' ? '/' : curr)) : eval(accu + curr));  
         return zw;
   }  

function loesung()
    {
        ctx.clearRect(xBasis, 380, 500, -24);               
        meldung("Lösung : " + string + "  = "+ ergebnis,"20px Arial","red",xBasis,yBasis1+ytextdis+110);  
       
    }


 canv.addEventListener('click', function(e)
     {       
        var rect = angetippt(rects, e.offsetX, e.offsetY);
        if (rect) 
        {
          auswahlButton();  
               
        }}, false);


function vergleich(a)
{
    if(a==ergebnisIndex+4)
        {
           richtig++;
            meldung(( "Anzahl Richtige :  " + richtig) +  " bei " + durchLaeufe + " Durchläufe","18px Arial","blue",xBasis, yBasis1+ytextdis+150);
            elapsedTime = Date.now() - startTime;
            elapsedTime = (elapsedTime / 1000).toFixed(2);       
            zeiten.push( Math.round( elapsedTime)); 

            var ausdruck=zeiten;
           
            for (var i= 0;i<zeiten.length-1;i++);
               {
               console.log("  1  " + summe );   
                summe+=zeiten[i];
                console.log("summe " +summe + "  " + zeiten);
            }
           
            var schnitt=(  summe/richtig); 
            schnitt=Math.floor(schnitt*10)/10;
            if(ausdruck.length>10){ausdruck.shift();}        
            meldung(( "Zeiten / Durchlauf ( Sek. ) :  " + ausdruck ),"18px Arial","blue",xBasis, yBasis1+ytextdis+185);
            meldung(( "Durchschnitt ( Sek. ) :  "  + schnitt),"18px Arial","blue",xBasis, yBasis1+ytextdis+215);
        }
    else 
        {
            meldung(( "Anzahl Richtige :  " + richtig) +  " bei " + durchLaeufe + " Durchläufe","18px Arial","blue",xBasis, yBasis1+ytextdis+150);
        }

    }

function angetippt(rects, x, y) {
    var zw;
    var isCollision = false;
    for (let i = 0, len = rects.length; i < len; i++) {
        var left = rects[i].x, right = rects[i].x+rects[i].w;
        var top = rects[i].y, bottom = rects[i].y+rects[i].h;
        if (right >= x
            && left <= x
            && bottom >= y
            && top <= y) {
                isCollision = rects[i];   
                getipptRechteck=i;        
          }
    }
    return isCollision;
}

function auswahlButton()

    {        
        switch (getipptRechteck) 
                {
                    case 0:                                         
                        start();
                        break;
                    case 1:
                        loesung();                        
                        break;
                    case 2:
                        rechenSchritte= plusMinus(rechenSchritte,1,1,11); 
                        meldung("Anzahl Ziffern = " + rechenSchritte,"18px Arial","blue",(xBasis + 2 * (wBasis2+ dBasis)) ,yBasis1+ytextdis+230);                          
                        start();                          
                        break;
                    case 3:
                        rechenSchritte= plusMinus(rechenSchritte,-1,1,11); 
                        meldung("Anzahl Ziffern = " + rechenSchritte,"18px Arial","blue",(xBasis + 2 * (wBasis2+ dBasis)) ,yBasis1+ytextdis+230);   
                        start();                          
                        break;
                     case 4:
                     case 5:
                     case 6:
                     case 7:
                     case 8:   
                     case 9:
                        durchLaeufe++;                  
                        vergleich(vergleich(getipptRechteck));                        
                        break;  
                                     
                    default:
                       alert("ups");
                }             
    }

function buttonErstellen()
{
       for (var i = 0, len = rects.length; i < len; i++) {
        ctx.rect(rects[i].x, rects[i].y, rects[i].w, rects[i].h); 
        ctx.stroke();  
        ctx.fillStyle=rects[i].col;  
        ctx.fillRect(rects[i].x, rects[i].y, rects[i].w, rects[i].h);
        
      }
}

function buttonText()
{ 
    ctx.fillStyle = "blue";
    ctx.font = "18px Arial";
    for (var i = 0, len = texts.length; i < len; i++) 
    {
       ctx.fillText(texts[i].na,texts[i].x, texts[i].y);
        
     }
     
}

function random(max)
          {
            return Math.floor((Math.random() *max));
          }

function boxMeldung(melde,x,y,w,h,k1,k2,o)
    {       
        ctx.rect(x,y,w,h);
        ctx.stroke();
        ctx.fillStyle=bgColor;
        ctx.fillRect(x,y,w,h);      
        meldung(melde,"25px Arial","blue",x+30,y+45  );
    }

    function plusMinus(ausgang,delta,unten,oben)
{
        // Mehr oder weniger Zeit zum Suchen
        let anz=ausgang; 
        if ((anz + delta)< oben && delta>0)
        {anz=anz + delta; }
        if ((anz + delta)> unten && delta<=0)
        {anz=anz + delta; }
        
        return anz;
}         


function meldung(text, schrift,farbe,xm,ym)
   {
        var lg = 20 + ctx.measureText(text).width 
        ctx.clearRect(xm, ym-25,lg,25);
        ctx.fillStyle = farbe;
        ctx.font = schrift;
        ctx.fillText(text, xm ,ym); 
    }

function getRndInteger(min, max) {
  return Math.floor(Math.random() * (max - min + 1) ) + min;
}

function isPrime(nr) {
  var factors = findFactors(nr); // Liste aller Teiler
  if (factors.length === 2) { // Wenn genau 2 Teiler
    return true; // nr ist Primzahl
  } else {
    return false; // nr ist keine Primzahl
  }
}


</script>


       
<p>Enjoy !</p>

</body>
</html>
